<html>
    <head>
        <title>Project 2</title>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
        <style> 
            
            body
            {
                font-family: sans-serif;
                background-color: #404040;
            }
            
            svg { 
                width: 60%;
                border: solid #ccc 0.75px;
                margin-left: 40px;
            } 
            
            .button{
                background-color: transparent;
                color: #CCCCCC;
                text-align: center;
                padding: 16px;
                text-decoration: none;
                display: inline-block;
                font-size: 14px;
                margin: 4px 2px;
                cursor: pointer;
                -webkit-transition-duration: 0.4s; /* Safari */
                transition-duration: 0.4s;
                border: 1px solid;
                outline: none;
                width:100%;
                border-radius: 6px;
                font-weight: 100;
            }
            
            #buttonHolder
            {
                display: inline-block;
                float: left;
                width:150px;
                margin: 20px;
            }
            
            #holder
            {
                display: inline-block;
                float: left;
            }
            
            h2, h3{
                
                color:white;
            }
            
        </style>
    </head>

    <body>
        <h2>F1 Race Results</h2>
        <h3>Races</h3>
        <div id="holder">
            <div id="buttonHolder"></div>
            <br>
            <svg id="Graph" width="1600" height="800">
            </svg>
        </div>
        <script>
            //List of Races in F1 2011
            var race_list = ["Belgium","Canada","EUGP","Germany","Hungary","India","Italy","Japan","Korea","Monaco","Silverstone","Singapore","Spain"]
            
            var race_color = ["#ee6d66","#f49cc8","#a866ee","#D23232","#7166ee","#3080e8","#107c91","#16c79e","#d59f80","#FFBF00","#FF7900","#56A902","#66d7ee"]
            
            //Load Data Files
            var race_data;
            var start_data;
            var result_data;
            
            var queue = d3.queue();
            race_list.forEach(function(race_name){
                //Queue all data files
                queue.defer(d3.json, "RaceData_JSON/"+race_name+".json")
                queue.defer(d3.json, "RaceStart_JSON/"+race_name+".json")
                queue.defer(d3.json, "RaceResults_JSON/"+race_name+".json")
            });
            queue.awaitAll(function (error, data){
                race_data = data;
                //Name all races
                for (i=0; i<race_list.length; i++){
                    race_data[i].name = race_list[i];
                }
            });
            
            
            
            
 
            //Function to initialize graph when button is clicked
            //
            // Called from "on click" event of a button
            // Creates graph of clicked race with top 3 finishers selected
            // Removes old graph stuff
            // Creates clickable buttons for each racer
            var race;
            var lapDataDict = {};
            var allDriversData = {};
                
            function initializeRace(racename) {
                /* refresh svg from previous race contents */
                d3.selectAll("#Graph > *").remove(); 

                var svgPlot = d3.select("#Graph");

                race = race_data.filter(function(d) {return d.name == racename;})[0]
                
                var maxNumberOfLaps = 0; // to later use for horizontal scale
                var raceDrivers = Object.keys(race);
                raceDrivers.splice(-1); //remove "name" element in array
                
                /* loop through racers to get max number of laps in particular race */
                for (var driver in race) {
                    if (driver != "name"){
                        var numLaps = Object.keys(race[driver]).length;
                        maxNumberOfLaps = numLaps > maxNumberOfLaps ? numLaps : maxNumberOfLaps;
                    }
                }

                /* Scales Used in SVG Graph:
                 * lapScale => horizontal
                 * positionScale => vertical
                 * driverScale => for unique driver-path colors
                 */
                var lapScale = d3.scaleLinear().domain([1, maxNumberOfLaps]).range([20, d3.select("#Graph").attr("width")-20]); // left & right padding of 20px 

                var lapAxis = d3.axisTop(lapScale);

                var positionScale = d3.scaleLinear().domain([1, raceDrivers.length]).range([25, d3.select("#Graph").attr("height")-25]);
                
                var driverScale = d3.scaleOrdinal().domain([raceDrivers]).range(["#5E4FA2", "#3288BD", "#66C2A5", "#ABDDA4", "#E6F598", "#FFFFBF", "#FEE08B", "#FDAE61", "#F46D43", "#D53E4F", "#9E0142"]);
                // console.log(driverScale(race[raceDrivers[0]]));

                svgPlot.append("g").call(lapAxis).attr("transform", "translate(0,20)");
            
                for(var i = 1; i <= maxNumberOfLaps; i++) { // get position of Drivers at Each Lap
                    var driversInLap = {}; // will be sorted in ascending order by timeBehindLeader
                    for (var driver in race) {
                        var timeBehindLeader;
                        if (driver == "name") {
                            continue;
                        }
                        if (i <= Object.keys(race[driver]).length) {
                            if (race[driver][i][0] == 1 && race[driver][i][1] == "PIT") {
                                timeBehindLeader = Number(race[driver][i][3]);
                            }
                            else {
                                timeBehindLeader = Number(race[driver][i][1]);
                            }
                            driversInLap[driver] = timeBehindLeader;  
                        }    
                    }
                    var driverPositionsOrdered = Object.keys(driversInLap).map(function(driver) {
                        return [driver, driversInLap[driver]];
                    });
                    driverPositionsOrdered.sort(function(first, second) {
                        return first[1] - second[1]
                    })
                    lapDataDict[i] = driverPositionsOrdered;
                }

               Object.prototype.getKeyByValue = function(value) {
                    for(var prop in this) {
                        if (this.hasOwnProperty(prop)) {
                            if (this[prop][0] == value)
                                return Number(prop)+1;
                        }
                    }
               }
               var lineGenerator = d3.line()
                    .x(function(d) { return lapScale(d.lap); })
                    .y(function(d) { return positionScale(d.position) });

               raceDrivers.forEach(function(d) {
                    var driverPositions = []; /* will correspond to y-values to later scale */
                    var nLapsDriverIsInRace = Object.keys(race[d]).length;

                    for (var lap = 1; lap <= nLapsDriverIsInRace; lap++) { // loop through each lap available
                        // console.log(lap);
                        var dataAtLap = lapDataDict[lap];
                        // console.log(dataAtLap);

                        /* find this driver's position at the current lap */

                        var position = dataAtLap.getKeyByValue(d);
                       // console.log("Driver: " + d + ", Lap: " + lap + " Position: " + position);

                       driverPositions.push({
                        "lap": lap, 
                        "position" : Number(position)});


                   } 
                   
                   /* once exited the for-loop, have driver's time from leader */

                   var pathString = lineGenerator(driverPositions);
                   svgPlot.append("path")
                       .attr("d", pathString)
                       .attr("stroke", driverScale(d))
                       .attr("stroke-width", 3)
                       .attr("fill", "none");
               }); 
            }
            
            
            
            
            
            //Adding buttons above SVG
            var button_holder = d3.select("#buttonHolder");
            var buttons = button_holder.selectAll("input").data(race_list);
            
            var buttonClicked = false;
            buttons.enter()
                .append("input")
                .attr("type","button")
                .attr("class","button")
                .attr("clicked","false")
                //.attr("id",function(d,i){return "button"+i})
                .attr("value", function (d){return d; })
                .style("border-color", function(d,i){return race_color[i];})
                .on("click", function(d,i)
                    {
                        if(d3.select(this).attr("clicked")=="false")
                            {
                                d3.select(this).attr("clicked","true")
                                d3.select(this).style("background-color",race_color[i]);
                                initializeRace(d);   
                            }
                        else
                            {
                                d3.select(this).attr("clicked","false")
                                d3.select(this).style("background-color","transparent");
                                //initializeRace(d); 
                            }
                })
                .on("mouseover", function(d,i)
                   {
                    d3.select(this).style("background-color",race_color[i]);
                    d3.select(this).style("color","white");
                    d3.select(this).style("font-weight",500);
                })
                .on("mouseout",function(d,i)
                   {
                       if(d3.select(this).attr("clicked")=="false")
                        {
                            d3.select(this).style("background-color","transparent"); 
                            d3.select(this).style("color","#CCCCCC"); 
                            d3.select(this).style("font-weight",100);
                        }
                });
          
           //console.log(buttons) 
            
            
        </script>        
    </body>
</html>