<html>
    <head>
        <title>Project 2</title>
        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
        <style> 
            
            body
            {
                font-family: sans-serif;
                background-color: #404040;
            }
            
            svg { 
                border: solid #ccc 0.75px;
                margin-left: 40px;
            } 
            
            .button{
                background-color: transparent;
                color: #CCCCCC;
                text-align: center;
                padding: 14px;
                text-decoration: none;
                display: inline-block;
                font-size: 14px;
                margin: 4px 2px;
                cursor: pointer;
                -webkit-transition-duration: 0.4s; /* Safari */
                transition-duration: 0.4s;
                border: 1px solid;
                outline: none;
                width:100%;
                border-radius: 6px;
                font-weight: 100;
            }
            
            #buttonHolder
            {
                display: inline-block;
                float: left;
                width:150px;
                margin: 20px;
            }
            
            #holder
            {
                display: inline-block;
                float: left;
                width:100%;
                

            }
            
            #headerHolder
            {
                height:100px;
                padding-left: 30px;
                padding-top: 30px;
                text-align: center;
            }
            
            h2, h3{
                
                color:white;
                vertical-align: middle;
                
            }
            
            h3
            {
                font-family: Palatino;
                font-weight: 200;
                line-height: 24px;
                letter-spacing: 1.3px;
            }
            
            .lapAxis text
            {
                fill:white;
            }
            
            .lapAxis line
            {
                stroke:white;
            }
            
            .lapAxis path
            {
                stroke:transparent;
            }
            
        </style>
    </head>

    <body>

        <div id="headerHolder">
            <h2>F1 Race Results 2011</h2>
            <h3></h3>
        </div>
        <div id="holder">
            <div id="buttonHolder"></div>
            <br>
            <svg id="Graph" width="1000" height="700">
            </svg>
        </div>
        <script>
            //List of Races in F1 2011
            var race_list = ["Belgium","Canada","EUGP","Germany","Hungary","India","Italy","Japan","Korea","Monaco","Silverstone","Singapore","Spain"]
            
            var race_color = ["#ee6d66","#f49cc8","#a866ee","#D23232","#7166ee","#3080e8","#107c91","#16c79e","#d59f80","#FFBF00","#FF7900","#56A902","#66d7ee"]
            
            //Load Data Files
            var race_data;
            var start_data = [];
            var result_data = [];
            
            var queue1 = d3.queue();
            var queue2 = d3.queue();
            var queue3 = d3.queue();
            
            function loadData(){
                race_list.forEach(function(race_name){
                    queue1.defer(d3.json, "RaceData_JSON/"+race_name+".json");
                    queue2.defer(d3.json, "RaceStart_JSON/"+race_name+".json");
                    queue3.defer(d3.json, "RaceResults_JSON/"+race_name+".json")
                });
                queue1.awaitAll(function (error, data){
                    race_data = data;
                    //Name all races
                    for (i=0; i<race_list.length; i++){
                        race_data[i].name = race_list[i];
                    }
                });
                queue2.awaitAll(function (error, data){
                    for (i=0; i<data.length; i++){
                        start_data.push(data[i].MRData.RaceTable.Races[0].QualifyingResults);
                    }
                });
                queue3.awaitAll(function (error, data){
                    for (i=0; i<data.length; i++){
                        result_data.push(data[i].MRData.RaceTable.Races[0]);
                    }
                });
            }
          
            
            loadData();
 
            //Function to initialize graph when button is clicked
            //
            // Called from "on click" event of a button
            // Creates graph of clicked race with top 3 finishers selected
            // Removes old graph stuff
            // Creates clickable buttons for each racer
            var race;
            var raceDrivers;
            var lapDataDict = {};
            var allDriversData = {};
                
            function initializeRace(racename) {
                /* refresh svg from previous race contents */
                d3.selectAll("#Graph > *").remove(); 

                var svgPlot = d3.select("#Graph");

                race = race_data.filter(function(d) {return d.name == racename;})[0]
                
                var maxNumberOfLaps = 0; // to later use for horizontal scale
                raceDrivers = Object.keys(race);
                raceDrivers.splice(-1); //remove "name" element in array
                
                /* loop through racers to get max number of laps in particular race */
                for (var driver in race) {
                    if (driver != "name"){
                        var numLaps = Object.keys(race[driver]).length;
                        maxNumberOfLaps = numLaps > maxNumberOfLaps ? numLaps : maxNumberOfLaps;
                    }
                }

                /* Scales Used in SVG Graph:
                 * lapScale => horizontal
                 * positionScale => vertical
                 * driverScale => for unique driver-path colors
                 */
                var lapScale = d3.scaleLinear().domain([1, maxNumberOfLaps]).range([20, d3.select("#Graph").attr("width")-20]); // left & right padding of 20px 

                var lapAxis = d3.axisTop(lapScale).ticks(50);


                var positionScale = d3.scaleLinear().domain([1, raceDrivers.length]).range([40, d3.select("#Graph").attr("height")-20]);

                
                var driverScale = d3.scaleOrdinal().domain([raceDrivers]).range(["#5E4FA2", "#3288BD", "#66C2A5", "#ABDDA4", "#E6F598", "#FFFFBF", "#FEE08B", "#FDAE61", "#F46D43", "#D53E4F", "#9E0142"]);
                // console.log(driverScale(race[raceDrivers[0]]));

                svgPlot.append("g").call(lapAxis).attr("transform", "translate(0,30)").attr("class", "lapAxis");
            
                for(var i = 1; i <= maxNumberOfLaps; i++) { // get position of Drivers at Each Lap
                    var driversInLap = {}; // will be sorted in ascending order by timeBehindLeader
                    for (var driver in race) {
                        var timeBehindLeader;
                        if (driver == "name") {
                            continue;
                        }
                        if (i <= Object.keys(race[driver]).length) {
                            if (race[driver][i][0] == 1 && race[driver][i][1] == "PIT") {
                                timeBehindLeader = Number(race[driver][i][3]);
                            }
                            else {
                                timeBehindLeader = Number(race[driver][i][1]);
                            }
                            driversInLap[driver] = timeBehindLeader;  
                        }    
                    }
                    var driverPositionsOrdered = Object.keys(driversInLap).map(function(driver) {
                        return [driver, driversInLap[driver]];
                    });
                    driverPositionsOrdered.sort(function(first, second) {
                        return first[1] - second[1]
                    })
                    lapDataDict[i] = driverPositionsOrdered;
                }

               Object.prototype.getKeyByValue = function(value) {
                    for(var prop in this) {
                        if (this.hasOwnProperty(prop)) {
                            if (this[prop][0] == value)
                                return Number(prop)+1;
                        }
                    }
               }
               var lineGenerator = d3.line()
                    .x(function(d) { return lapScale(d.lap); })
                    .y(function(d) { return positionScale(d.position) });

                
               
               raceDrivers.forEach(function(d, i) {
                    var driverPositions = []; /* will correspond to y-values to later scale */
                    var nLapsDriverIsInRace = Object.keys(race[d]).length;

                    for (var lap = 1; lap <= nLapsDriverIsInRace; lap++) { // loop through each lap available
                        // console.log(lap);
                        var dataAtLap = lapDataDict[lap];
                        // console.log(dataAtLap);

                        /* find this driver's position at the current lap */

                        var position = dataAtLap.getKeyByValue(d);
                       // console.log("Driver: " + d + ", Lap: " + lap + " Position: " + position);

                       driverPositions.push({
                        "lap": lap, 
                        "position" : Number(position)});

                        allDriversData[d] = driverPositions;

                   } 
                   
                   /* once exited the for-loop, have driver's time from leader */

                   var pathString = lineGenerator(driverPositions);

                   svgPlot.append("path")
                       .attr("d", pathString)
                       .attr("class", "line")
                       .attr("id", "line" + i)
                       .attr("stroke", driverScale(d))
                       .attr("stroke-width", 3)
                       .attr("fill", "none")
                       .on("mouseover", function(d) {
                            d3.selectAll(".line")
                                .style("opacity", ".2");
                            d3.select(this).style("opacity", "1");
                            d3.select(this).style("stroke-width", "5");
                            d3.selectAll(".driver" + i)
                                .style("opacity", "1");
                            d3.select("h3").text("Driver: "+raceDrivers[i].slice(0,4)+raceDrivers[i].slice(4,raceDrivers.length).toLowerCase()); 
                            d3.select(this).style("cursor","pointer")
                       

                       })
                       .on("mouseout", function(d) {
                            d3.selectAll(".line")
                                .style("opacity", "1")
                                .style("stroke-width", "3");
                           
                            d3.selectAll("circle")
                                .style("opacity", "0");
                            d3.select("h3").text("");  
                       });

                    
                    svgPlot.selectAll("dot")
                        .data(driverPositions)
                        .enter()
                        .append("circle")
                        .attr("r", "2")
                        .attr("class", "driver" + i)
                        .attr("stroke", "white")
                        .attr("cx", function(d) { return lapScale(d.lap); })
                        .attr("cy", function(d) { return positionScale(d.position); })
                        .attr("cy", function(d) { return positionScale(d.position); });

                    /* initially set all lines to no show */
                    d3.selectAll(".line").style("opacity", "0");
                    d3.selectAll("circle").style("opacity", "0");

               }); 
               animatelines();
            }
            
            /* for each line, need to know the driver's end position to multiply by duration */

            function animatelines() {
                
                d3.selectAll(".line")
                    .style("opacity", "1");

                d3.selectAll(".line").each(function(d, i) {
                    var currDriver = raceDrivers[i];
                    var endPosition = allDriversData[currDriver][allDriversData[currDriver].length-1].position;

                    var totalLength = d3.select("#line" + i).node().getTotalLength();

                    d3.selectAll("#line" + i)
                        .attr("stroke-dasharray", totalLength + " " + totalLength)
                        .attr("stroke-dashoffset", totalLength)
                        .transition()
                        .duration(1000*endPosition) /* depends on finishing position */
                        .delay(100*i)
                        .ease(d3.easeLinear)
                        .attr("stroke-dashoffset", "0");
                }); 

            }
        
            
            
            //Adding buttons above SVG
            var button_holder = d3.select("#buttonHolder");
            var buttons = button_holder.selectAll("input").data(race_list);
            
            var buttonClicked = false;
            buttons.enter()
            .append("input")
            .attr("type","button")
            .attr("class","button")
            .attr("clicked","false")
            //.attr("id",function(d,i){return "button"+i})
            .attr("value", function (d){return d; })
            .style("border-color", function(d,i){return race_color[i];})
            .on("click", function(d,i)
                {
                    if(d3.select(this).attr("clicked")=="false")
                        {
                            clearButtons()
                            d3.select(this).attr("clicked","true")
                            makeButtonColored(this,i)
                            initializeRace(d);   
                        }
                    else
                        {
                            d3.select(this).attr("clicked","false")
                            makeButtonTransparent(this)
                            //initializeRace(d); 
                        }
            })
            .on("mouseover", function(d,i)
               {
                makeButtonColored(this,i)
            })
            .on("mouseout",function(d)
               {
                   if(d3.select(this).attr("clicked")=="false")
                    {
                        makeButtonTransparent(this);
                    }
            });
          
            function clearButtons()
            {
                button_holder.selectAll("input").
                style("background-color","transparent")
                .style("color","#CCCCCC")
                .style("font-weight",100)
                .attr("clicked","false");
            }
            
            function makeButtonColored(btn, i)
            {
                d3.select(btn).style("background-color",race_color[i]);
                d3.select(btn).style("color","white");
                d3.select(btn).style("font-weight",500); 
            }
            
            function makeButtonTransparent(btn)
            {
                d3.select(btn).style("background-color","transparent"); 
                d3.select(btn).style("color","#CCCCCC"); 
                d3.select(btn).style("font-weight",100);
            }
            
           //console.log(buttons) 
            
            
        </script>        
    </body>
</html>